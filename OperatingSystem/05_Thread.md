# Thread

## 개요

- CPU 이용의 기본 단위이다.
- 스레드의 구성 요소
    - 스레드 ID
    - 프로그램 카운터(PC)
    - 레지스터 집합
    - 스택
- 같은 프로세스에서 공유하는 자원
    - 코드
    - 데이터 섹션
    - 열린 파일이나 신호와 같은 운영체제 자원들

## 스레드 사용 시 장점

- 응답성
    - 단일 스레드 응용 프로그램은 그 연산이 완료될 때까지 사용자에게 응답하지 않을 것이다.
    - 하지만 비동기적 스레드에서 실행된다면 여전히 사용자에게 응답할 수 있다.
- 자원 공유
    - 프로세스는 공유 메모리(shared Memory)와 메세지 전달(message Parsing) 기법을 통해서만 자원을 공유할 수 있다. → 프로그래머가 명시해야 함.
    - 스레드는 자동으로 그들이 속한 프로세스의 자원들과 메모리를 공유한다.
    - 코드와 데이터 공유의 이점은 한 응용 프로그램이 같은 주소 공간 내에 여러 개의 다른 작업을 하는 스레드를 가질 수 있다는 점이다.
- 경제성
    - 프로세스 생성을 위해 메모리와 자원을 할당하는 것은 비용이 많이 드는 작업이다.
    - 스레드는 자신이 속한 프로세스의 자원들을 공유하기 때문에, 스레드를 생성하고 문맥교환하는 것이 더욱더 경제적이다. 오버헤드의 차이를 경험적으로 측정하는 것은 어려울 수 있지만, 일반적으로 스레드 생성은 프로세스 생성보다 시간과 메모리를 덜 소비한다. 또한 문맥 교환은 일반적으로 프로세스 사이보다 스레드 사이에서 더 빠르다.
- 규모 적응성
    - 다중 처리기 구조에서는 각각의 스레드가 다른 처리기에서 병렬로 수행될 수 있기 때문에 다중 스레드의 이점이 더욱 증가한다.
    

## 병렬 실행의 유형

- 데이터 병렬 실행
    - 동일한 데이터의 부분집합을 다수의 계산 코어에 분배한 뒤 각 코어에서 동일한 연산을 실행
        
        예시: 배열의 1~n 까지 합을 계산 하면 1~[n/2-1]을 합하고 [n/2]~n 합 연산을 각자의 계산 코어에 분배한다.
        
- 테스크 병렬 실행
    - 테스크(스레드를) 다수의 코어에 분배한다. 각 스레드는 고유의 연산을 실행한다. 각각의 스레드들이 동일한 데이터에 대한 연산을 실행할 수도 있고 아닐 수도 있다.

## 다중 스레드 모델

- 사용자 스레드
    - 사용자 수준에서 제공되는 스레드
    - 커널 위에서 지원되며, 커널의 지원 없이 관리된다.
- 커널 스레드
    - 커널 수준에서 제공되는 스레드
    - 운영체제에 의해 직접 지원되고 관리 된다.

### 사용자 스레드와 커널 스레드는 어떤 연관 관계가 존재해야 한다.

- 다대일 모델
    - 많은 사용자 수준 스레드를 하나의 커널 스레드로 사상한다.
    - 스레드 관리는 사용자 공간의 스레드 라이브러리에 의해 행해진다.
    - 하지만 한 스레드가 봉쇄형 시스템콜을 할 경우, 전체 프로세스가 봉쇄된다.
- 일대일 모델
    - 각 사용자 스레드를 각각 하나의 커널 스레드로 사상한다.
    - 하나의 스레드가 봉쇄적 시스템 콜을 호출하더라도 다른 스레드가 실행될 수 있기 때문에 다대일 모델 보다 더 많은 병렬성을 제공한다.
    - 단점: 사용자 스레드를 만들려면 해당 커널 스레드를 만들어야 하며 많은 수의 커널 스레드가 시스템 성능에 부담을 줄 수 있다는 것이다.
- 다대다 모델
    - 사용자 수준 스레드를 그보다 작은 수 혹은 같은 수의 커널 스레드로 멀티플렉스 한다. 커널 스레드 수는 응용 프로그램이나 특정 기계에 따라 결정된다.
    - 다대일 모델은 개발자가 원하는 만큼의 사용자 수준 스레드를 생성하도록 허용하지만 커널은 한번에 하나의 커널 스레드만 스케줄 할수  있기 때문에 진정한 병렬 실행을 획득할 수 없다.
    - 일대일 모델은 더 많은 병행 실행을 제공하지만, 개발자가 한 응용 내에 너무 많은 스레드의 수가 생성하지 않도록 주의해야 한다.
    - 다대다 모델은 이러한 두가지 단점을 해결한다. 개발자는 필요한 만큼 많은 사용자 수준 스레드를 생성할 수 있고, 그에 상응하는 커널스레드가 다중 처리기에서 병렬로 수행될 수 있다. 또한, 스레드가 봉쇄형 시스템 콜을 발생시켰을 때, 커널이 다른 스레드의 수행을 스케줄 할 수 있다.
    - 한 사용자 스레드가 하나의 커널 스레드에만 연관된는 것을 허용한다.
    - 구현하기가 어려워 대부분의 운영체제에서 일대일 모델을 사용한다. 또한 대부분의 시스템에서 처리 코어 수가 증가함에 따라 커널 스레드 수를 제한하는 것의 중요성이 줄어들었다.

### 스레드 라이브러리

- 프로그래머에게 스레드를 생성하고 관리하기 위한 API를 제공한다. 스레드 라이브러리를 구현하는 데에는 주된 두 가지 방법이 있다.
- 첫 번째 방법은 커널의 지원 없이 완전히 사용자 공간에서만 라이브러리를 제공하는 것이다. 라이브러리 함수를 호출하는 것은 시스템 콜이 아니라 온전히 사용자 공간의 지역함수를 호출하는 것을 의미한다.
- 두 번째 방법은 운영체제에 의해 지원되는 커널 수준 라이브러리를 구현하는 것이다. 이 경우, 라이브러리를 위한 코드와 자료구조는 커널 공간에 존재한다. 라이브러리 API를 호출하는 것은 커널 시스템 콜을 부르는 결과를 낳는다.

## 암묵적 스레딩

- 암묵적 스레딩은 스레딩의 생성과 관리 책임을 응용 개발자로부터 컴파일러와 실행시간 라이브러리에게 넘겨주어 병행 및 병렬 응용의 설계를 도와주는 방법이다.

### 스레드 풀

- 스레드의 문제점
    - 프로세스를 새로 생성하는 것보다 스레드를 생성하는 것은 비용이 덜 들지만, 여전히 스레드를 새로 생성하는 것은 시스템 입장에서 부담일 수 있다.
    - 모든 요청마다 새 스레드를 만들면 최대 스레드 수가 몇 개까지 가능할 수 있는 것인지 한계를 정해야 한다. 스레드를 무한정 만들면 언젠가는 CPU 시간, 메모리 공간과 같은 자원이 고갈 된다.
- 스레드 풀의 개념
    - 스레드 풀은 프로세스를 시작할 때, 처음 부터 일정한 수의 스레드를 미리 만들어 두는 것이다. 평소에는 일을하지 않고 기다리다가 요청을 받으면 스레드 풀에 제출하고 추가 요청을 대기를 재개한다. 풀에 사용 가능한 스레드가 있으면 깨어나고 요청이 즉시 서비스 된다. 풀에 사용 가능한 스레드가 없으면 사용 가능한 스레드가 생길 때까지 작업이 대기 된다.
- 스레드 풀의 장점
    1. 새 스레드를 만들어 주기보다 기존 스레드를 서비스해 주는 것이 종종 더 빠르다.
    2. 스레드 풀은 임의 시각에 존재할 스레드 개수에 제한을 둔다. 이러한 제한은 많은 수의 스레드를 병렬 처리할 수 없는 시스템에 도움이 준다.
    3. 태스크를 생성하는 방법을 태스크로부터 분리하면 태스크를 실행을 다르게 할 수 있다. 예를 들어 태스크를 일정 시간 후에 실행되도록 스케줄 하거나 혹은 주기적으로 실행시킬 수 있다.
    4. 스레드 풀에 있는 스레드의 개수는 CPU 수, 물리 메모리 용량, 동시 요청 클라이언트 최대 개수 등을 고려하여 정해질 수 있다. 풀의 활용도를 보며 동적으로 풀의 크기를 바꾸어줄 수도 있다.

### Fork Join

- 스레드 생성 전략 중 하나이다. 이 메소드를 사용하면 메인 부모 스레드가 하나 이상의 자식 스레드를 생성(fork)하고 다음 자식의 종료를 기다린 후 join하고 그 시점 부터 자식의 결과를 확인하고 결합할 수 있다.
- 이 동기식 모델은 명시적 스레드라고 특정지어지지만, 암시적 스레딩에도 사용될 수 있다. fork 단계에서는 스레드가 직접 구축되지 않고 대신 병렬 작업이 식별 된다.

## 스레드와 관련된 문제들

### fork() 및 Exec() 시스템 콜

- 만약 한 스레드가 fork()를 호출하면 새로운 모든 프로세스는 모든 스레드를 복제해야 하는가 아니면 한개의 스레드만 가지는 프로세스여야 하는가? 몇몇 UNIX는 두가지 다 제공하는데,
- 응용 프로그램 환경에 따라 다르다. fork()를 하자마자 exec() 실행한다면 곧 모든 것이 다시 대체될 것이기 때문에 이 경우에는 시스템 콜을 호출한 스레드만 복사해주는 것이 적절하다.
- fork()만 실행한다면 전체를 복사해주어야 한다.

### 신호 처리

- UNIX에서 프로세스에 어떤 이벤트가 일어났음을 알려주기 위해 사용된다.
- 알려줄 신호의 근원지나 이유에 따라 동기식 또는 비동기식으로 전달될 수 있다.
    1. 신호는 특정 이벤트가 일어나야 생성된다.
    2. 생성된 신호가 프로세스에 전달된다.
    3. 신호가 전달되면 반드시 처리되야 한다.
- 동기적 신호는 신호를 발생시킨 연산을 수행한 동일한 프로세스에 전달된다.
    - 동기적 신호의 예) 불법적인 메모리 접근 / 0으로 나누기 등
- 신호가 실행 중인 프로세스 외부에서 발생하면 그 프로세스는 신호를 비동기식으로 전달 받는다.
    - 신호의 예) 특수 키를 눌러서 프로세스를 강제 종료 시키거나, 타이머가 만료되는 경우가 포함.
- 모든 신호는 둘 중 하나의 처리기에 의해 처리된다.
    - 디폴트 신호 처리기
    - 사용자 정의 신호 처리기
- 모든 신호마다 커널이 실행 시키는 디폴트 신호처리기가 있다. 이 디폴트 처리기는 신호를 처리하기 위하여 호출되는 사용자 정의 처리기에 의해 대체될 수 있다. 신호를 처리할 때, 일부 신호는 무시될 수 있지만 다른 신호는 프로그램을 종료하여 처리된다.
- 단일 스레드 프로그램에서 신호처리는 간단하다. 신호는 항상 프로세스에 전달 된다.
- 프로세스가 여러 스레드를 가지고 있다면 어떻게 해야하는가?
    1. 신호가 적용될 스레드에게 전달한다.
        1. 동기식 신호를 전달할때, 신호를 야기한 스레드에 동기식 신호를 전달하고 다른 스레드에 전달되면 안된다.
    2. 모든 스레드에 전달한다.
        1. 강제 종료와 같이 비동기식 신호의 경우 모든 스레드에 전달되어야 한다.
    3. 몇몇 스레드들에만 선택적으로 전달한다.
    4. 특정 스레드가 모든 신호를 전달받도록 지정한다.

### 스레드 취소

- 스레드가 끝나기 전에 강제종료 시키는 작업을 일컫는다. 데이터베이스를 병렬로 검색하고 있다가, 한 스레드가 결과를 찾으면 나머지 스레드는 종료되어도 된다.
- 이 처럼 취소되어야 하는 스레드를 목적 스레드라고 한다.
- 비 동기식 취소: 한 스레드가 즉시 목적 스레드를 강제 종료 시킨다.
    - 스레드가 다른 스레드와 공유하는 자료구조를 갱신하는 도중에 취소요청이 와도 문제가 된다. 비동기식 취소의 경우, 종종 운영체제는 취소된 스레드로 부터 시스템 자원을 회수할 수도 있지만 모든 시스템 자원을 회수하지 못하는 경우도 있다. 따라서, 비동기식으로 스레드를 취소하면 필요한 시스템 자원을 다 사용 가능한 상태로 만들지 못할 수도 있다.
- 지연취소: 목적 스레드가 주기적으로 자신이 강제 종료 되어야 할지를 점검한다.

### 스레드 로컬 저장장치 (Thread-Local Storage)

- 한 프로세스에 속한 스레드들은 그 프로세스의 데이터를 모두 공유한다.
- 하지만 자기만 액세스할 수 있는 데이터를 가져야 할 필요도 있다. 그러한 데이터를 스레드-로컬 저장장치

### 스케줄러 액티베이션

- 스레드 라이브러리와 커널 통신의 조정은 응용 프로그램이 최고의 성능을 보이도록 보장하기 위하여 커널 스레드의 수를 동적으로 조절하는 것을 가능하게 한다.
- 다대다 또는 두 수준 모델을 구현하는 많은 시스템은 사용자와 커널 스레드 사이에 중간 자료구조를 둔다. 이 자료구조는 통상 경량 프로세스 또는 LWP라고 불린다.
- 사용자 스레드 라이브러리와 커널 스레드 간의 통신 방법: 커널은 응용에 가상 처리기(LWP)를 집합을 제공하고 응용은 사용자 스레드를 가용한 가상 처리기로 스케줄 한다. 게다가 커널은 응용에게 특정 이벤트에 대해 알려줘야 한다. 이 프로시저를 upcall이라고 부른다. upcall은 스레드 라이브러리에 upcall처리기에 의해서 처리되고 upcall 처리기는 가상 처리기상에서 실행되어야 한다.